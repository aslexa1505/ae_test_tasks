History Service
===============

Сервис для хранения и получения истории действий с товарами и остатками.

Описание
--------

History Service --- сервис для хранения событий, связанных с товарами и остатками. Предоставляет API для записи событий и получения истории действий с возможностью фильтрации и пагинации.

Функциональность
----------------

-   Принимает события от Inventory Service и сохраняет их в базу данных.
-   Предоставляет API для получения истории действий с фильтрацией по:
    -   `shop_id`
    -   `plu`
    -   `date` (с-по)
    -   `action`
-   Поддерживает постраничную навигацию (пагинацию).

Технологии
----------

-   **Node.js** и **Express** для создания сервера.
-   **TypeScript** для типизации кода.
-   **PostgreSQL** для хранения данных.
-   **Sequelize** в качестве ORM.
-   **Winston** для логирования.

Требования
----------

-   **Node.js** версии 14 или выше.
-   **npm** или **yarn**.
-   **PostgreSQL** установленный и настроенный.
-   **TypeScript** глобально установленный (опционально).

Установка
---------

1.  **Клонируйте репозиторий:**

    ```bash
    git clone https://github.com/yourusername/history-service.git
    cd history-service
    ```

2.  **Установите зависимости:**

    ```bash
    npm install
    ```
    или

    ```bash
    yarn install
    ```

Конфигурация
------------

1.  **Создайте файл `.env` в корневой директории:**

    ```dotenv
    DB_USERNAME=your_db_username
    DB_PASSWORD=your_db_password
    DB_NAME=history_service
    DB_HOST=127.0.0.1
    PORT=4000
    ```

    Замените `your_db_username` и `your_db_password` на ваши данные для подключения к базе данных PostgreSQL.

2.  **Настройте подключение к базе данных в `src/config/database.ts`**, если необходимо.

Запуск
------

1.  **Создайте базу данных PostgreSQL:**

    ```bash
    createdb history_service
    ```

2.  **Запустите миграции для создания таблиц:**

    ```bash
    npx sequelize-cli db:migrate
    ```

3.  **Запустите сервис:**

    ```bash
    npm start
    ```

    Сервис будет доступен по адресу `http://localhost:4000` или по порту, указанному в файле `.env`.

API Эндпоинты
-------------

### Добавление записи в историю

-   **URL:** `POST /api/history`

-   **Тело запроса:**

    ```json
    {
      "shopId": 1,
      "plu": "12345",
      "action": "INCREASE_STOCK",
      "timestamp": "2024-12-02T10:00:00.000Z"
    }
    ```

-   **Описание полей:**

    -   `shopId`: Идентификатор магазина (обязательное).
    -   `plu`: PLU товара (обязательное).
    -   `action`: Действие, совершенное с товаром или остатком (обязательное).
    -   `timestamp`: Время совершения действия (опционально, по умолчанию текущее время).

### Получение истории с фильтрацией

-   **URL:** `GET /api/history`

-   **Параметры запроса (Query Params):**

    -   `shop_id` (опционально): Фильтр по ID магазина.
    -   `plu` (опционально): Фильтр по PLU товара.
    -   `action` (опционально): Фильтр по типу действия.
    -   `date_from` и `date_to` (опционально): Диапазон дат для фильтрации по времени действия.
    -   `page` (опционально): Номер страницы для пагинации (по умолчанию `1`).
    -   `limit` (опционально): Количество записей на страницу (по умолчанию `20`).
-   **Пример запроса:**

    ```bash
    GET /api/history?shop_id=1&plu=12345&action=INCREASE_STOCK&date_from=2024-12-01&date_to=2024-12-31&page=1&limit=10
    ```

-   **Пример ответа:**

    ```json
    {
      "total": 2,
      "page": 1,
      "pages": 1,
      "data": [
        {
          "id": 1,
          "shopId": 1,
          "plu": "12345",
          "action": "INCREASE_STOCK",
          "timestamp": "2024-12-02T10:00:00.000Z",
          "createdAt": "2024-12-02T10:00:00.000Z",
          "updatedAt": "2024-12-02T10:00:00.000Z"
        },
        {
          "id": 2,
          "shopId": 1,
          "plu": "12345",
          "action": "INCREASE_STOCK",
          "timestamp": "2024-12-03T12:00:00.000Z",
          "createdAt": "2024-12-03T12:00:00.000Z",
          "updatedAt": "2024-12-03T12:00:00.000Z"
        }
      ]
    }
    ```

Примеры запросов
----------------

-   **Добавление записи в историю:**

    ```bash
    curl -X POST http://localhost:4000/api/history\
    -H 'Content-Type: application/json'\
    -d '{
      "shopId": 1,
      "plu": "12345",
      "action": "INCREASE_STOCK"
    }'
    ```

-   **Получение истории:**

    ```bash
    curl "http://localhost:4000/api/history?shop_id=1&plu=12345&action=INCREASE_STOCK"
    ```